@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // click (+) lần đầu
            document.querySelectorAll(".add-to-cart").forEach(btn => {
                btn.addEventListener("click", async () => {
                    const productId = btn.dataset.productId;
                    const storeId = btn.dataset.storeId;
                    //const userId = "userId";

                    if (!userId || userId === "0") {
                        const currentUrl = window.location.pathname + window.location.search;
                        window.location.href = `/Authentication/Login?returnUrl=${encodeURIComponent(currentUrl)}`;
                        return;
                    }

                    const dto = { storeId, productId, quantity: 1 };

                    try {
                        const response = await fetch(`/Product/AddProductToCart?buyer=${userId}`, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(dto)
                        });

                        if (response.ok) {
                            const result = await response.json();

                            // thay đổi UI thành (- qty +)
                            const container = document.getElementById(`cart-actions-${productId}`);
                            container.innerHTML = `
                                <div class="d-flex justify-content-end align-items-center">
                                    <button class="btn btn-sm btn-light border decrease"
                                            data-product-id="${productId}" data-store-id="${storeId}">-</button>
                                    <span class="mx-2 fw-bold quantity-value" id="qty-${productId}">1</span>
                                    <button class="btn btn-sm btn-light border increase"
                                            data-product-id="${productId}" data-store-id="${storeId}">+</button>
                                </div>`;

                            // update cart menu-bar
                            const cartBadge = document.getElementById("cartBadge");
                            if (cartBadge) {
                                cartBadge.textContent = result.countItems;
                                cartBadge.classList.remove("bg-secondary");
                                cartBadge.classList.add("bg-danger");
                            }

                            // update cart store
                            const cartBadgeFloating = document.getElementById("cartBadgeFloating");
                            if (cartBadgeFloating) {
                                cartBadgeFloating.textContent = result.countItems;
                                cartBadgeFloating.classList.remove("bg-secondary");
                                cartBadgeFloating.classList.add("bg-danger");
                            }

                            // render lại modal giỏ hàng
                            renderCartModal(result.cartStore);

                            // đổi nút thành - qty +
                            const container = document.getElementById(`cart-actions-${productId}`);
                            container.innerHTML = `
                                <div class="d-flex justify-content-end align-items-center">
                                    <button class="btn btn-sm btn-light border decrease"
                                            data-product-id="${productId}" data-store-id="${storeId}">-</button>
                                    <span class="mx-2 fw-bold quantity-value" id="qty-${productId}">1</span>
                                    <button class="btn btn-sm btn-light border increase"
                                            data-product-id="${productId}" data-store-id="${storeId}">+</button>
                                </div>`;

                            bindQuantityButtons(productId, storeId, userId);
                        } else {
                            alert("❌ Lỗi thêm giỏ hàng");
                        }
                    } catch (err) {
                        console.error("Network error:", err);
                    }
                });
            });


            // bind lại nút + -
            function bindQuantityButtons(productId, storeId, userId) {
                const container = document.getElementById(`cart-actions-${productId}`);
                const qtySpan = document.getElementById(`qty-${productId}`);

                container.querySelectorAll(".increase, .decrease").forEach(btn => {
                    btn.addEventListener("click", async () => {
                        let currentQty = parseInt(qtySpan.textContent);

                        if (btn.classList.contains("increase")) {
                            currentQty++;
                        } else if (btn.classList.contains("decrease") && currentQty > 1) {
                            currentQty--;
                        } else if (btn.classList.contains("decrease") && currentQty === 1) {
                            //nếu giảm về 0 thì quay lại nút (+)
                            container.innerHTML = `
                                <button class="btn btn-primary btn-sm add-to-cart"
                                        data-product-id="${productId}" data-store-id="${storeId}">+</button>`;
                            container.querySelector(".add-to-cart").addEventListener("click", () => {
                                document.querySelector(`#cart-actions-${productId} .add-to-cart`).click();
                            });
                            return;
                        }

                        //disable tránh spam
                        btn.disabled = true;
                        qtySpan.textContent = "...";

                        try {
                            const response = await fetch(`/Order/UpdateQuantity?userId=${userId}&productId=${productId}`, {
                                method: "PUT",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ productId, quantity: currentQty })
                            });

                            if (response.ok) {
                                const result = await response.json();
                                qtySpan.textContent = currentQty;

                                //cập nhật badge
                                const cartBadge = document.getElementById("cartBadge");
                                if (cartBadge) cartBadge.textContent = result.data.totalItems;
                            } else {
                                qtySpan.textContent = currentQty; rollback
                                alert("❌ Lỗi cập nhật số lượng");
                            }
                        } catch (err) {
                            console.error("Network error:", err);
                            qtySpan.textContent = currentQty;
                        } finally {
                            btn.disabled = false;
                        }
                    });
                });
            }
        });
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // Gắn sự kiện click cho danh mục
            document.querySelectorAll(".category-link").forEach(item => {
                item.addEventListener("click", function () {
                    // bỏ class active cũ
                    document.querySelectorAll(".category-link").forEach(el => el.classList.remove("active"));

                    // thêm class active cho item hiện tại
                    this.classList.add("active");

                    // lấy target
                    const targetId = this.getAttribute("data-target");
                    const targetEl = document.getElementById(targetId);

                    if (targetEl) {
                        targetEl.scrollIntoView({
                            behavior: "smooth", // cuộn mượt
                            block: "start"
                        });
                    }
                });
            });
        });
    </script>


    <script>
            // Hàm render giỏ hàng trong modal
            function renderCartModal(cartItems) {
                const listContainer = document.getElementById("modal-body-item-list");
                const totalEl = document.getElementById("cart-total");

                if (!cartItems || cartItems.length === 0) {
                    listContainer.innerHTML = `<p class="text-center text-muted">Giỏ hàng trống</p>`;
                    totalEl.textContent = "0 đ";
                    return;
                }

                let html = "";
                let total = 0;
                cartItems.forEach(item => {
                    total += item.price * item.quantity;
                    html += `
                        <div class="d-flex align-items-center border-bottom py-2">
                            <div class="flex-shrink-0">
                                <img src="${item.productImage}" alt="${item.productName}"
                                     class="img-thumbnail" style="width:60px; height:60px; object-fit:cover;">
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="mb-1">${item.productName}</h6>
                                <div class="fw-bold text-danger mt-1">${item.price.toLocaleString()} đ</div>
                            </div>
                            <div class="d-flex align-items-center">
                                <button class="btn btn-sm btn-outline-secondary decrease"
                                        data-product-id="${item.productId}" data-store-id="${item.storeId}">-</button>
                                <span class="mx-2 fw-bold">${item.quantity}</span>
                                <button class="btn btn-sm btn-outline-secondary increase"
                                        data-product-id="${item.productId}" data-store-id="${item.storeId}">+</button>
                            </div>
                        </div>`;
                });

                listContainer.innerHTML = html;
                totalEl.textContent = total.toLocaleString() + " đ";
            };
    </script>


}
