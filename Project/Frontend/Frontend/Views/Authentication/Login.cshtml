@using Frontend.Models.Auth
@using Frontend.Models.Auth.Requests
@model LoginModel

@{
    ViewData["Title"] = "Log in";
}

<div class="container d-flex justify-content-center min-vh-100">
    <div class="w-50">
        <h2 class="text-center mb-4">Login</h2>

        <form asp-action="Login" method="post">
            <input type="hidden" name="returnUrl" value="@ViewData["ReturnUrl"]" />
            <div>
                <label>Email</label>
                <input asp-for="Email" class="form-control form-control-sm" />
                <span asp-validation-for="Email" class="text-danger"></span>
            </div>
            <div>
                <label>Password</label>
                <input asp-for="Password" type="password" class="form-control form-control-sm" />
                <span asp-validation-for="Password" class="text-danger"></span>
            </div>
            <button type="submit" class="btn btn-primary mt-3">Login</button>
            <button type="button" class="btn btn-link mt-2" id="forgotPasswordBtn">Forgot Password</button>


            @if (ViewBag.Error != null)
            {
                <p style="color:red">@ViewBag.Error</p>
            }
        </form>
    </div>
</div>

<!-- Verify Email Modal -->
<div class="modal fade" id="verifyEmailModal" tabindex="-1" aria-labelledby="verifyEmailLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-sm">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="verifyEmailLabel">Xác minh email</h5>
            </div>
            <div class="modal-body text-center">
                <p>Nhập mã xác minh gồm 6 chữ số đã được gửi đến <b id="verifyEmailAddress"></b></p>

                <div class="d-flex justify-content-center gap-2 mb-3">
                    @for (int i = 0; i < 6; i++)
                    {
                        <input type="text" maxlength="1" class="form-control text-center code-input" style="width: 45px; font-size: 20px;" />
                    }
                </div>

                <p class="text-muted" id="countdownText">Mã hết hạn sau: <span id="countdown">2:00</span></p>

                <button id="resendBtn" class="btn btn-outline-secondary btn-sm" disabled>Gửi lại mã</button>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="verifyBtn">Xác thực</button>
            </div>
        </div>
    </div>
</div>

<!-- Forgot Password Modal -->
<div class="modal fade" id="forgotPasswordModal" tabindex="-1" aria-labelledby="forgotPasswordLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-sm">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title" id="forgotPasswordLabel">Quên mật khẩu</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="forgotEmail" class="form-label">Nhập email của bạn</label>
                    <input type="email" class="form-control" id="forgotEmail" placeholder="example@email.com" required />
                    <div class="text-danger mt-1" id="forgotError"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="forgotConfirmBtn">Xác thực Email</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        (function() {
            // ✅ Khai báo biến global để truyền data từ server
            window.showVerifyModal = @Json.Serialize(ViewBag.ShowVerifyModal ?? false);
            window.unverifiedEmail = @Json.Serialize(ViewBag.UnverifiedEmail ?? "");

            let countdownInterval;
            let remainingTime = 120; // 2 minutes
            let email = "";

            // Khởi động countdown
            function startCountdown() {
                clearInterval(countdownInterval);
                countdownInterval = setInterval(() => {
                    remainingTime--;
                    const minutes = Math.floor(remainingTime / 60);
                    const seconds = remainingTime % 60;
                    const countdownElem = document.getElementById("countdown");
                    const textElem = document.getElementById("countdownText");
                    const resendBtn = document.getElementById("resendBtn");

                    if (countdownElem) {
                        countdownElem.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    }

                    if (remainingTime <= 0) {
                        clearInterval(countdownInterval);
                        if (resendBtn) resendBtn.disabled = false;
                        if (textElem) textElem.textContent = "Mã đã hết hạn!";
                    }
                }, 1000);
            }

            // DOM loaded
            document.addEventListener("DOMContentLoaded", () => {
                // ✅ Đọc từ window object
                const showModal = window.showVerifyModal;
                email = window.unverifiedEmail || "";

                console.log("showVerifyModal:", showModal); // Debug
                console.log("email:", email); // Debug

                // ✅ Xử lý returnUrl
                if (!localStorage.getItem("preLoginUrl")) {
                    localStorage.setItem("preLoginUrl", document.referrer || window.location.origin);
                }

                const returnUrlInput = document.querySelector('input[name="returnUrl"]');
                if (returnUrlInput && !returnUrlInput.value) {
                    const preUrl = localStorage.getItem("preLoginUrl");
                    if (preUrl) returnUrlInput.value = preUrl;
                }

                document.querySelector("form").addEventListener("submit", () => {
                    localStorage.removeItem("preLoginUrl");
                });

                // ✅ Nếu cần mở modal verify
                if (showModal && email) {
                    const modalEl = document.getElementById('verifyEmailModal');
                    const emailElem = document.getElementById("verifyEmailAddress");
                    if (emailElem) emailElem.textContent = email;

                    if (modalEl) {
                        const modal = new bootstrap.Modal(modalEl);
                        modal.show();
                        startCountdown();

                        (async () => {
                            try {
                                const res = await fetch('/Authentication/login-resend-code', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ email })
                                });

                                if (res.ok) {
                                    console.log("✅ Đã gửi mã xác minh đến:", email);
                                    alert("✅ Mã xác minh đã được gửi đến " + email);
                                } else {
                                    console.warn("⚠️ Gửi mã thất bại!");
                                    alert("⚠️ Không thể gửi mã xác minh!");
                                }
                            } catch (err) {
                                console.error("❌ Lỗi khi gửi mã xác minh:", err);
                                alert("❌ Lỗi hệ thống khi gửi mã!");
                            }
                        })();
                    }
                }

                // Tự động nhảy sang ô kế tiếp khi nhập mã
                document.querySelectorAll(".code-input").forEach((input, index, arr) => {
                    input.addEventListener("input", (e) => {
                        if (e.target.value && index < arr.length - 1) arr[index + 1].focus();
                    });

                    // ✅ Xử lý backspace
                    input.addEventListener("keydown", (e) => {
                        if (e.key === "Backspace" && !e.target.value && index > 0) {
                            arr[index - 1].focus();
                        }
                    });
                });

                // Nút gửi lại mã
                const resendBtn = document.getElementById("resendBtn");
                if (resendBtn) {
                    resendBtn.addEventListener("click", async () => {
                        resendBtn.disabled = true;
                        try {
                            const res = await fetch('/Authentication/login-resend-code', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ email })
                            });

                            if (res.ok) {
                                remainingTime = 600;
                                startCountdown();
                                alert("✅ Mã xác minh mới đã được gửi!");
                            } else {
                                alert("⚠️ Gửi lại mã thất bại!");
                                resendBtn.disabled = false;
                            }
                        } catch (err) {
                            console.error("Resend error:", err);
                            alert("❌ Lỗi hệ thống khi gửi lại mã!");
                            resendBtn.disabled = false;
                        }
                    });
                }

                // Nút xác minh mã
                const verifyBtn = document.getElementById("verifyBtn");
                if (verifyBtn) {
                    verifyBtn.addEventListener("click", async () => {
                        const code = Array.from(document.querySelectorAll(".code-input"))
                            .map(i => i.value)
                            .join("");

                        if (code.length !== 6) {
                            alert("⚠️ Vui lòng nhập đủ 6 chữ số!");
                            return;
                        }

                        try {
                            const res = await fetch('/Authentication/login-verify', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ email, code })
                            });

                            if (res.ok) {
                                alert("🎉 Xác minh thành công! Đang chuyển hướng...");
                                const redirectTo = localStorage.getItem("preLoginUrl") || "/Home/Index";
                                localStorage.removeItem("preLoginUrl");
                                window.location.href = redirectTo;
                            } else {
                                const err = await res.text();
                                alert("❌ Xác minh thất bại: " + err);
                            }
                        } catch (err) {
                            console.error("Verify error:", err);
                            alert("❌ Lỗi hệ thống khi xác minh!");
                        }
                    });
                }
            });

                    // ========== Quên mật khẩu ==========
            const forgotBtn = document.getElementById("forgotPasswordBtn");
            if (forgotBtn) {
                forgotBtn.addEventListener("click", () => {
                    const modalEl = document.getElementById("forgotPasswordModal");
                    if (modalEl) {
                        const modal = new bootstrap.Modal(modalEl);
                        modal.show();
                    }
                });
            }

            const forgotConfirmBtn = document.getElementById("forgotConfirmBtn");
            if (forgotConfirmBtn) {
                forgotConfirmBtn.addEventListener("click", async () => {
                    const emailInput = document.getElementById("forgotEmail");
                    const errorElem = document.getElementById("forgotError");
                    const email = emailInput.value.trim();
                    errorElem.textContent = "";

                    if (!email) {
                        errorElem.textContent = "Vui lòng nhập email!";
                        return;
                    }

                    try {
                        const res = await fetch('/Authentication/forgot-password', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(email)
                        });

                        if (res.ok) {
                            alert("✅ Link đổi mật khẩu đã được gửi về email của bạn!");
                            window.location.href = "/Authentication/login";
                        } else {
                            const msg = await res.text();
                            errorElem.textContent = msg || "❌ Gửi email thất bại, vui lòng thử lại!";
                        }
                    } catch (err) {
                        console.error("Forgot password error:", err);
                        errorElem.textContent = "❌ Lỗi hệ thống, vui lòng thử lại!";
                    }
                });
            }

        })();
    </script>
}